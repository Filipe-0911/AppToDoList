name: Maven Package

on:
  push:
    branches: [master]

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: "Baixar o código"
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.VPS_SSH }}

      - name: "Copiar arquivos para VPS"
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_VPS }}
          username: ${{ secrets.USER_VPS }}
          password: ${{ secrets.PASSWORD }}
          source: "."
          target: "/AppToDoList"

      - name: "Build da aplicação"
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST_VPS }}
          username: ${{ secrets.USER_VPS }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /AppToDoList
            mvn clean compile -DskipTests
            mvn clean package -DskipTests

      - name: "Finalizar processo antigo"
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST_VPS }}
          username: ${{ secrets.USER_VPS }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /AppToDoList
            # Verificar e finalizar o processo antigo que está rodando o .jar
            JAR_PID=$(ps aux | grep 'App-0.0.1-SNAPSHOT.jar' | grep -v grep | awk '{print $2}')
            if [ -n "$JAR_PID" ]; then
              echo "Finalizando o processo antigo com PID: $JAR_PID"
              kill -9 $JAR_PID
            else
              echo "Nenhum processo antigo encontrado"
            fi
            
            sleep 5

      - name: "Rodar aplicação"
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.HOST_VPS }}
          username: ${{ secrets.USER_VPS }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /AppToDoList
            # Certificar que o nohup está rodando corretamente
            echo "Iniciando aplicação com nohup..."
            nohup java -jar target/App-0.0.1-SNAPSHOT.jar > output.log 2>&1 &
            disown
            echo "Aplicação iniciada. Logs disponíveis em output.log."


